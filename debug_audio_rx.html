<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>éŸ³é¢‘æ¥æ”¶è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        
        .debug-section {
            background: #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        
        .status {
            background: #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        .info { color: #00aaff; }
        
        .button {
            background: linear-gradient(145deg, #ff6600, #cc4400);
            border: 2px solid #ff8800;
            border-radius: 8px;
            padding: 12px 20px;
            color: white;
            font-weight: bold;
            margin: 5px;
            cursor: pointer;
        }
        
        .button:active {
            transform: scale(0.95);
        }
        
        .meter {
            width: 100%;
            height: 20px;
            background: #222;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .meter-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <h1>ğŸ”Š éŸ³é¢‘æ¥æ”¶è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-section">
        <h2>è¿æ¥çŠ¶æ€</h2>
        <div class="status" id="connection-status">ç­‰å¾…è¿æ¥...</div>
        <button class="button" onclick="connectWebSocket()">è¿æ¥WebSocket</button>
        <button class="button" onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
    </div>
    
    <div class="debug-section">
        <h2>éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€</h2>
        <div class="status" id="audio-context-status">æœªåˆå§‹åŒ–</div>
        <button class="button" onclick="initAudioContext()">åˆå§‹åŒ–éŸ³é¢‘</button>
        <button class="button" onclick="testAudioPlayback()">æµ‹è¯•éŸ³é¢‘æ’­æ”¾</button>
    </div>
    
    <div class="debug-section">
        <h2>éŸ³é¢‘æ•°æ®ç›‘æ§</h2>
        <div class="meter">
            <div class="meter-bar" id="audio-level-meter" style="width: 0%"></div>
        </div>
        <div class="status" id="audio-data-status">ç­‰å¾…éŸ³é¢‘æ•°æ®...</div>
        <div class="status" id="buffer-status">ç¼“å†²åŒº: 0</div>
    </div>
    
    <div class="debug-section">
        <h2>è°ƒè¯•æ—¥å¿—</h2>
        <div class="status" id="debug-log" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let wsAudioRX = null;
        let audioContext = null;
        let audioSourceNode = null;
        let audioGainNode = null;
        let audioAnalyser = null;
        let audioBuffer = [];
        let isConnected = false;
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
        }
        
        // WebSocketè¿æ¥
        function connectWebSocket() {
            if (wsAudioRX && wsAudioRX.readyState === WebSocket.OPEN) {
                log('WebSocketå·²è¿æ¥', 'warning');
                return;
            }
            
            log('æ­£åœ¨è¿æ¥WebSocket...', 'info');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const baseUrl = `${protocol}//${window.location.host}`;
            
            wsAudioRX = new WebSocket(`${baseUrl}/WSaudioRX`);
            wsAudioRX.binaryType = 'arraybuffer';
            
            wsAudioRX.onopen = function() {
                isConnected = true;
                log('WebSocketè¿æ¥æˆåŠŸ', 'success');
                document.getElementById('connection-status').innerHTML = '<span class="success">âœ… å·²è¿æ¥</span>';
                
                // è¿æ¥æˆåŠŸååˆå§‹åŒ–éŸ³é¢‘
                initAudioContext();
            };
            
            wsAudioRX.onmessage = function(event) {
                handleAudioData(event.data);
            };
            
            wsAudioRX.onclose = function() {
                isConnected = false;
                log('WebSocketè¿æ¥å…³é—­', 'warning');
                document.getElementById('connection-status').innerHTML = '<span class="error">âŒ è¿æ¥å…³é—­</span>';
            };
            
            wsAudioRX.onerror = function(error) {
                log('WebSocketé”™è¯¯: ' + error, 'error');
                document.getElementById('connection-status').innerHTML = '<span class="error">âŒ è¿æ¥é”™è¯¯</span>';
            };
        }
        
        function disconnectWebSocket() {
            if (wsAudioRX) {
                wsAudioRX.close();
                wsAudioRX = null;
            }
            isConnected = false;
            document.getElementById('connection-status').innerHTML = '<span class="warning">âš ï¸ å·²æ–­å¼€</span>';
        }
        
        // éŸ³é¢‘ä¸Šä¸‹æ–‡åˆå§‹åŒ–
        function initAudioContext() {
            try {
                if (!window.AudioContext && !window.webkitAudioContext) {
                    log('Web Audio APIä¸æ”¯æŒ', 'error');
                    return;
                }
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    latencyHint: "interactive",
                    sampleRate: 44100
                });
                
                log(`AudioContextåˆ›å»ºæˆåŠŸï¼ŒçŠ¶æ€: ${audioContext.state}ï¼Œé‡‡æ ·ç‡: ${audioContext.sampleRate}Hz`, 'success');
                
                if (audioContext.state === 'suspended') {
                    log('AudioContextè¢«æš‚åœï¼Œéœ€è¦ç”¨æˆ·äº¤äº’', 'warning');
                    document.getElementById('audio-context-status').innerHTML = '<span class="warning">âš ï¸ å·²æš‚åœï¼Œéœ€è¦ç”¨æˆ·äº¤äº’</span>';
                    
                    // æ·»åŠ ç”¨æˆ·äº¤äº’ç›‘å¬å™¨
                    const resumeAudio = () => {
                        audioContext.resume().then(() => {
                            log('AudioContextå·²æ¢å¤', 'success');
                            setupAudioNodes();
                        }).catch(err => {
                            log('æ¢å¤AudioContextå¤±è´¥: ' + err.message, 'error');
                        });
                    };
                    
                    document.addEventListener('touchstart', resumeAudio, { once: true });
                    document.addEventListener('click', resumeAudio, { once: true });
                } else {
                    setupAudioNodes();
                }
                
            } catch (error) {
                log('åˆå§‹åŒ–AudioContextå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // è®¾ç½®éŸ³é¢‘èŠ‚ç‚¹
        function setupAudioNodes() {
            try {
                // åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹
                audioGainNode = audioContext.createGain();
                audioAnalyser = audioContext.createAnalyser();
                audioSourceNode = audioContext.createScriptProcessor(256, 1, 1);
                
                // è®¾ç½®éŸ³é¢‘å¤„ç†é“¾
                audioSourceNode.connect(audioGainNode);
                audioGainNode.connect(audioAnalyser);
                audioGainNode.connect(audioContext.destination);
                
                // è®¾ç½®éŸ³é¢‘å¤„ç†å‡½æ•°
                audioSourceNode.onaudioprocess = processAudioData;
                
                // å¯åŠ¨éŸ³é¢‘æºèŠ‚ç‚¹
                audioSourceNode.start(0);
                
                // è®¾ç½®å¢ç›Š
                audioGainNode.gain.value = 0.8;
                
                log('éŸ³é¢‘èŠ‚ç‚¹è®¾ç½®å®Œæˆ', 'success');
                document.getElementById('audio-context-status').innerHTML = '<span class="success">âœ… éŸ³é¢‘å·²åˆå§‹åŒ–</span>';
                
                // å¼€å§‹ç›‘æ§
                startAudioMonitoring();
                
            } catch (error) {
                log('è®¾ç½®éŸ³é¢‘èŠ‚ç‚¹å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // å¤„ç†éŸ³é¢‘æ•°æ®
        function processAudioData(event) {
            const outputBuffer = event.outputBuffer.getChannelData(0);
            
            if (audioBuffer.length === 0) {
                // æ²¡æœ‰æ•°æ®æ—¶è¾“å‡ºé™éŸ³
                for (let i = 0; i < outputBuffer.length; i++) {
                    outputBuffer[i] = 0;
                }
                return;
            }
            
            // å¤„ç†éŸ³é¢‘æ•°æ®
            const audioData = audioBuffer.shift();
            const minLength = Math.min(audioData.length, outputBuffer.length);
            
            for (let i = 0; i < minLength; i++) {
                outputBuffer[i] = audioData[i];
            }
            
            // å¡«å……å‰©ä½™ç©ºé—´
            for (let i = minLength; i < outputBuffer.length; i++) {
                outputBuffer[i] = 0;
            }
            
            // æ›´æ–°éŸ³é¢‘ç”µå¹³æ˜¾ç¤º
            updateAudioLevel(outputBuffer);
        }
        
        // å¤„ç†æ¥æ”¶åˆ°çš„éŸ³é¢‘æ•°æ®
        function handleAudioData(data) {
            try {
                const audioData = new Float32Array(data);
                audioBuffer.push(audioData);
                
                // æ£€æŸ¥éŸ³é¢‘æ•°æ®
                const maxValue = Math.max(...audioData);
                if (maxValue > 0.01) {
                    log(`æ”¶åˆ°éŸ³é¢‘æ•°æ®ï¼Œæœ€å¤§å€¼: ${maxValue.toFixed(4)}`, 'success');
                }
                
                // æ›´æ–°ç¼“å†²åŒºçŠ¶æ€
                document.getElementById('buffer-status').innerHTML = `ç¼“å†²åŒº: ${audioBuffer.length}`;
                
                // é˜²æ­¢ç¼“å†²åŒºè¿‡å¤§
                if (audioBuffer.length > 10) {
                    log('ç¼“å†²åŒºè¿‡å¤§ï¼Œä¸¢å¼ƒæ—§æ•°æ®', 'warning');
                    audioBuffer = audioBuffer.slice(-5);
                }
                
            } catch (error) {
                log('å¤„ç†éŸ³é¢‘æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ›´æ–°éŸ³é¢‘ç”µå¹³æ˜¾ç¤º
        function updateAudioLevel(audioData) {
            const maxValue = Math.max(...audioData);
            const level = Math.min(100, maxValue * 100);
            
            document.getElementById('audio-level-meter').style.width = level + '%';
            
            if (level > 1) {
                document.getElementById('audio-data-status').innerHTML = `<span class="success">éŸ³é¢‘ç”µå¹³: ${level.toFixed(1)}%</span>`;
            } else {
                document.getElementById('audio-data-status').innerHTML = '<span class="warning">éŸ³é¢‘ç”µå¹³: é™éŸ³</span>';
            }
        }
        
        // å¼€å§‹éŸ³é¢‘ç›‘æ§
        function startAudioMonitoring() {
            setInterval(() => {
                if (audioAnalyser) {
                    const dataArray = new Float32Array(audioAnalyser.frequencyBinCount);
                    audioAnalyser.getFloatFrequencyData(dataArray);
                    
                    const maxFreq = Math.max(...dataArray);
                    if (maxFreq > -60) {
                        log(`é¢‘è°±åˆ†æ - æœ€å¤§é¢‘ç‡: ${maxFreq.toFixed(1)}dB`, 'info');
                    }
                }
            }, 1000);
        }
        
        // æµ‹è¯•éŸ³é¢‘æ’­æ”¾
        function testAudioPlayback() {
            if (!audioContext) {
                log('è¯·å…ˆåˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡', 'error');
                return;
            }
            
            try {
                // åˆ›å»ºæµ‹è¯•éŸ³é¢‘
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440; // A4éŸ³ç¬¦
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                
                log('æ’­æ”¾æµ‹è¯•éŸ³é¢‘ (440Hz)', 'success');
                
                // 1ç§’ååœæ­¢
                setTimeout(() => {
                    oscillator.stop();
                    log('æµ‹è¯•éŸ³é¢‘æ’­æ”¾å®Œæˆ', 'success');
                }, 1000);
                
            } catch (error) {
                log('æµ‹è¯•éŸ³é¢‘æ’­æ”¾å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿æ¥
        document.addEventListener('DOMContentLoaded', function() {
            log('è°ƒè¯•é¡µé¢å·²åŠ è½½', 'info');
            connectWebSocket();
        });
    </script>
</body>
</html>

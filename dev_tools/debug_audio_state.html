<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>éŸ³é¢‘çŠ¶æ€è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        
        .debug-section {
            background: #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        
        .status {
            background: #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        .info { color: #00aaff; }
        
        .button {
            background: linear-gradient(145deg, #ff6600, #cc4400);
            border: 2px solid #ff8800;
            border-radius: 8px;
            padding: 12px 20px;
            color: white;
            font-weight: bold;
            margin: 5px;
            cursor: pointer;
        }
        
        .button:active {
            transform: scale(0.95);
        }
        
        .spectrum-display {
            width: 100%;
            height: 200px;
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .audio-level {
            width: 100%;
            height: 20px;
            background: #222;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .audio-level-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <h1>ğŸ”Š éŸ³é¢‘çŠ¶æ€è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-section">
        <h2>å½“å‰éŸ³é¢‘çŠ¶æ€</h2>
        <div class="status" id="audio-state">æ£€æŸ¥ä¸­...</div>
        <button class="button" onclick="checkAudioState()">åˆ·æ–°çŠ¶æ€</button>
        <button class="button" onclick="resetAudioState()">é‡ç½®éŸ³é¢‘çŠ¶æ€</button>
    </div>
    
    <div class="debug-section">
        <h2>é¢‘è°±æ˜¾ç¤ºæµ‹è¯•</h2>
        <canvas class="spectrum-display" id="test-spectrum" width="800" height="200"></canvas>
        <div class="status" id="spectrum-info">é¢‘è°±ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
        <button class="button" onclick="testSpectrum()">æµ‹è¯•é¢‘è°±æ˜¾ç¤º</button>
    </div>
    
    <div class="debug-section">
        <h2>éŸ³é¢‘ç”µå¹³ç›‘æ§</h2>
        <div class="audio-level">
            <div class="audio-level-bar" id="rx-level" style="width: 0%"></div>
        </div>
        <div class="status" id="level-info">RXç”µå¹³: 0%</div>
        <button class="button" onclick="startLevelMonitoring()">å¼€å§‹ç›‘æ§</button>
        <button class="button" onclick="stopLevelMonitoring()">åœæ­¢ç›‘æ§</button>
    </div>
    
    <div class="debug-section">
        <h2>è°ƒè¯•æ—¥å¿—</h2>
        <div class="status" id="debug-log" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        // æ¨¡æ‹ŸéŸ³é¢‘çŠ¶æ€å˜é‡
        let muteRX = false;
        let AudioRX_analyser = null;
        let AudioTX_analyser = null;
        let monitoringInterval = null;
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
        }
        
        // æ£€æŸ¥éŸ³é¢‘çŠ¶æ€
        function checkAudioState() {
            const stateElement = document.getElementById('audio-state');
            
            let stateInfo = `muteRX: ${muteRX}\n`;
            stateInfo += `AudioRX_analyser: ${AudioRX_analyser ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
            stateInfo += `AudioTX_analyser: ${AudioTX_analyser ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
            
            // æ¨¡æ‹Ÿé¢‘è°±æ˜¾ç¤ºé€»è¾‘
            let spectrumSource = 'æœªçŸ¥';
            if (muteRX && AudioTX_analyser) {
                spectrumSource = 'AudioTX_analyser (MIC)';
            } else if (AudioRX_analyser) {
                spectrumSource = 'AudioRX_analyser (RX)';
            }
            
            stateInfo += `å½“å‰é¢‘è°±æº: ${spectrumSource}\n`;
            
            if (muteRX && AudioTX_analyser) {
                stateInfo += '\nâš ï¸ è­¦å‘Š: é¢‘è°±æ˜¾ç¤ºçš„æ˜¯MICå£°éŸ³ï¼Œä¸æ˜¯æ¥æ”¶éŸ³é¢‘ï¼';
                stateElement.innerHTML = `<span class="warning">${stateInfo}</span>`;
            } else if (AudioRX_analyser) {
                stateInfo += '\nâœ… æ­£å¸¸: é¢‘è°±æ˜¾ç¤ºæ¥æ”¶éŸ³é¢‘';
                stateElement.innerHTML = `<span class="success">${stateInfo}</span>`;
            } else {
                stateElement.innerHTML = `<span class="error">${stateInfo}</span>`;
            }
            
            log('éŸ³é¢‘çŠ¶æ€æ£€æŸ¥å®Œæˆ', 'info');
        }
        
        // é‡ç½®éŸ³é¢‘çŠ¶æ€
        function resetAudioState() {
            muteRX = false;
            log('éŸ³é¢‘çŠ¶æ€å·²é‡ç½®', 'success');
            checkAudioState();
        }
        
        // æ¨¡æ‹ŸtoggleaudioRXå‡½æ•°
        function toggleaudioRX(stat = "None") {
            muteRX = !muteRX;
            if (stat !== "None") { muteRX = stat; }
            
            log(`toggleaudioRX called, muteRX: ${muteRX}, stat: ${stat}`, 'info');
            checkAudioState();
        }
        
        // æµ‹è¯•é¢‘è°±æ˜¾ç¤º
        function testSpectrum() {
            const canvas = document.getElementById('test-spectrum');
            const ctx = canvas.getContext('2d');
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgb(0, 0, 0)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æµ‹è¯•é¢‘è°±
            ctx.fillStyle = 'rgb(255, 255, 0)';
            for (let i = 0; i < canvas.width; i++) {
                const height = Math.random() * canvas.height * 0.8;
                ctx.fillRect(i, canvas.height - height, 1, height);
            }
            
            // æ˜¾ç¤ºé¢‘è°±ä¿¡æ¯
            const spectrumInfo = document.getElementById('spectrum-info');
            if (muteRX && AudioTX_analyser) {
                spectrumInfo.innerHTML = '<span class="warning">âš ï¸ å½“å‰æ˜¾ç¤ºMICé¢‘è°±</span>';
            } else {
                spectrumInfo.innerHTML = '<span class="success">âœ… å½“å‰æ˜¾ç¤ºRXé¢‘è°±</span>';
            }
            
            log('é¢‘è°±æ˜¾ç¤ºæµ‹è¯•å®Œæˆ', 'info');
        }
        
        // å¼€å§‹ç”µå¹³ç›‘æ§
        function startLevelMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            monitoringInterval = setInterval(() => {
                // æ¨¡æ‹ŸéŸ³é¢‘ç”µå¹³
                const level = Math.random() * 100;
                const levelBar = document.getElementById('rx-level');
                const levelInfo = document.getElementById('level-info');
                
                levelBar.style.width = level + '%';
                levelInfo.innerHTML = `RXç”µå¹³: ${level.toFixed(1)}%`;
                
                if (level > 50) {
                    levelInfo.innerHTML = `<span class="success">${levelInfo.innerHTML}</span>`;
                } else if (level > 20) {
                    levelInfo.innerHTML = `<span class="warning">${levelInfo.innerHTML}</span>`;
                } else {
                    levelInfo.innerHTML = `<span class="error">${levelInfo.innerHTML}</span>`;
                }
            }, 100);
            
            log('å¼€å§‹ç”µå¹³ç›‘æ§', 'success');
        }
        
        // åœæ­¢ç”µå¹³ç›‘æ§
        function stopLevelMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            log('åœæ­¢ç”µå¹³ç›‘æ§', 'info');
        }
        
        // æ¨¡æ‹ŸPTTæ“ä½œ
        function simulatePTT() {
            log('æ¨¡æ‹ŸPTTæŒ‰ä¸‹', 'info');
            toggleaudioRX(true);
            
            setTimeout(() => {
                log('æ¨¡æ‹ŸPTTé‡Šæ”¾', 'info');
                toggleaudioRX(false);
                resetAudioState();
            }, 2000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('è°ƒè¯•é¡µé¢å·²åŠ è½½', 'info');
            
            // æ¨¡æ‹Ÿåˆå§‹åŒ–éŸ³é¢‘åˆ†æå™¨
            AudioRX_analyser = { fftSize: 1024 };
            AudioTX_analyser = { fftSize: 1024 };
            
            checkAudioState();
            
            // æ·»åŠ æµ‹è¯•æŒ‰é’®
            const testSection = document.querySelector('.debug-section');
            const testButton = document.createElement('button');
            testButton.className = 'button';
            testButton.textContent = 'æ¨¡æ‹ŸPTTæ“ä½œ';
            testButton.onclick = simulatePTT;
            testSection.appendChild(testButton);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATU连接问题诊断</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: white;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #4CAF50;
            text-align: center;
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .step {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .step-number {
            background: #4CAF50;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        .code {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }

        .button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .success { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .error { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .warning { background: rgba(255, 152, 0, 0.2); color: #FF9800; }

        .navigation {
            text-align: center;
            margin: 30px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ATU连接问题诊断</h1>

        <div class="section">
            <h2>常见连接问题</h2>
            
            <div class="step">
                <span class="step-number">1</span>
                <strong>ATU设备未开机</strong>
                <p>确保ATU设备已经开机并正常运行。</p>
            </div>

            <div class="step">
                <span class="step-number">2</span>
                <strong>IP地址不正确</strong>
                <p>默认IP地址是 <code>192.168.1.12</code>，请确认您的ATU设备实际使用的IP地址。</p>
                <div class="code">
                    检查方法：<br>
                    - 查看ATU设备显示屏上的IP地址<br>
                    - 使用路由器管理界面查看连接的设备<br>
                    - 使用网络扫描工具
                </div>
            </div>

            <div class="step">
                <span class="step-number">3</span>
                <strong>端口配置错误</strong>
                <p>ATU设备默认使用端口 <code>60001</code> 提供WebSocket服务。</p>
                <div class="code">
                    常见端口：<br>
                    - WebSocket: 60001<br>
                    - HTTP: 80<br>
                    - 其他可能端口: 81, 8080, 8081
                </div>
            </div>

            <div class="step">
                <span class="step-number">4</span>
                <strong>网络连接问题</strong>
                <p>确保您的计算机和ATU设备在同一网络中。</p>
                <div class="code">
                    网络检查：<br>
                    - 检查网络连接<br>
                    - 确认防火墙设置<br>
                    - 测试网络连通性
                </div>
            </div>
        </div>

        <div class="section">
            <h2>快速诊断工具</h2>
            
            <div class="step">
                <button class="button" onclick="testConnection()">测试ATU连接</button>
                <button class="button" onclick="scanPorts()">扫描端口</button>
                <button class="button" onclick="checkNetwork()">检查网络</button>
            </div>

            <div id="testResults"></div>
        </div>

        <div class="section">
            <h2>解决方案</h2>
            
            <div class="step">
                <span class="step-number">1</span>
                <strong>使用ATU诊断工具</strong>
                <p>使用专门的诊断工具来测试连接：</p>
                <div class="navigation">
                    <a href="atu_diagnostic.html" class="button">打开ATU诊断工具</a>
                </div>
            </div>

            <div class="step">
                <span class="step-number">2</span>
                <strong>检查ATU设备状态</strong>
                <p>直接访问ATU设备的Web界面：</p>
                <div class="code">
                    http://192.168.1.12/
                </div>
                <p>如果这个地址可以访问，说明ATU设备运行正常。</p>
            </div>

            <div class="step">
                <span class="step-number">3</span>
                <strong>配置正确的IP和端口</strong>
                <p>在ATU监控页面中配置正确的设备信息：</p>
                <div class="navigation">
                    <a href="atu_monitor.html" class="button">返回ATU监控页面</a>
                </div>
            </div>
        </div>

        <div class="navigation">
            <a href="atu_monitor.html" class="button">返回ATU监控</a>
            <a href="index.html" class="button">返回主界面</a>
        </div>
    </div>

    <script>
        function testConnection() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<div class="test-result warning">正在测试连接...</div>';

            // 测试HTTP连接
            fetch('http://192.168.1.12/', { method: 'GET', mode: 'no-cors' })
                .then(() => {
                    results.innerHTML += '<div class="test-result success">✓ HTTP连接成功 - ATU设备在线</div>';
                    testWebSocket();
                })
                .catch(() => {
                    results.innerHTML += '<div class="test-result error">✗ HTTP连接失败 - ATU设备可能离线</div>';
                });
        }

        function testWebSocket() {
            const results = document.getElementById('testResults');
            
            try {
                const ws = new WebSocket('ws://192.168.1.12:60001/');
                
                const timeout = setTimeout(() => {
                    results.innerHTML += '<div class="test-result error">✗ WebSocket连接超时 - 端口可能不正确</div>';
                    ws.close();
                }, 5000);
                
                ws.onopen = () => {
                    clearTimeout(timeout);
                    results.innerHTML += '<div class="test-result success">✓ WebSocket连接成功 - 监控功能可用</div>';
                    ws.close();
                };
                
                ws.onerror = () => {
                    clearTimeout(timeout);
                    results.innerHTML += '<div class="test-result error">✗ WebSocket连接失败 - 检查端口配置</div>';
                };
                
            } catch (error) {
                results.innerHTML += '<div class="test-result error">✗ WebSocket连接异常: ' + error.message + '</div>';
            }
        }

        function scanPorts() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<div class="test-result warning">正在扫描端口...</div>';

            const ports = [60001, 80, 81, 8080, 8081];
            let tested = 0;

            ports.forEach(port => {
                testPort(port).then(isOpen => {
                    tested++;
                    if (isOpen) {
                        results.innerHTML += `<div class="test-result success">✓ 端口 ${port} 开放</div>`;
                    } else {
                        results.innerHTML += `<div class="test-result">端口 ${port} 关闭</div>`;
                    }
                    
                    if (tested === ports.length) {
                        results.innerHTML += '<div class="test-result warning">端口扫描完成</div>';
                    }
                });
            });
        }

        function testPort(port) {
            return new Promise((resolve) => {
                let socket;
                const timeout = setTimeout(() => {
                    if (socket) socket.close();
                    resolve(false);
                }, 2000);

                try {
                    socket = new WebSocket(`ws://192.168.1.12:${port}/`);
                    
                    socket.onopen = () => {
                        clearTimeout(timeout);
                        socket.close();
                        resolve(true);
                    };

                    socket.onerror = () => {
                        clearTimeout(timeout);
                        resolve(false);
                    };

                    socket.onclose = () => {
                        clearTimeout(timeout);
                        resolve(false);
                    };
                } catch (error) {
                    clearTimeout(timeout);
                    resolve(false);
                }
            });
        }

        function checkNetwork() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<div class="test-result warning">正在检查网络...</div>';

            // 简单的网络检查
            const img = new Image();
            img.onload = () => {
                results.innerHTML += '<div class="test-result success">✓ 网络连接正常</div>';
            };
            img.onerror = () => {
                results.innerHTML += '<div class="test-result error">✗ 网络连接问题</div>';
            };
            img.src = 'https://www.google.com/favicon.ico?t=' + Date.now();
        }
    </script>
</body>
</html>
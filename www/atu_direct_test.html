<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATU直接连接测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .control-panel {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .data-display {
            background-color: #e8f4fd;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .log {
            background-color: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .connect-btn {
            background-color: #4CAF50;
            color: white;
        }
        .disconnect-btn {
            background-color: #f44336;
            color: white;
        }
        .sync-btn {
            background-color: #2196F3;
            color: white;
        }
        .clear-btn {
            background-color: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <h1>ATU直接连接测试</h1>
    
    <div class="control-panel">
        <h2>连接控制</h2>
        <button class="connect-btn" onclick="connectDirect()">直接连接ATU</button>
        <button class="disconnect-btn" onclick="disconnectDirect()">断开连接</button>
        <button class="sync-btn" onclick="sendDirectSync()">发送同步命令</button>
        <button class="clear-btn" onclick="clearLog()">清空日志</button>
    </div>
    
    <div class="data-display">
        <h2>ATU数据</h2>
        <p>功率: <span id="power-value">--</span> W</p>
        <p>驻波比: <span id="swr-value">--</span></p>
        <p>最大功率: <span id="max-power-value">--</span> W</p>
        <p>效率: <span id="efficiency-value">--</span> %</p>
        <p>连接状态: <span id="connection-status">未连接</span></p>
    </div>
    
    <div class="log">
        <h2>调试日志</h2>
        <div id="log-content"></div>
    </div>

    <script>
        let atuSocket = null;
        let isConnected = false;
        let messageCount = 0;
        
        // 日志函数
        function log(message, type = 'info') {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toISOString().substr(11, 12);
            const typeClass = type === 'error' ? 'error' : 
                             type === 'success' ? 'success' : 
                             type === 'warning' ? 'warning' : 'info';
            
            logContent.innerHTML += `<div class="${typeClass}">[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
            
            // 限制日志行数
            const lines = logContent.querySelectorAll('div');
            if (lines.length > 500) {
                logContent.removeChild(lines[0]);
            }
        }
        
        // 更新连接状态显示
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (statusElement) {
                statusElement.textContent = connected ? '已连接' : '未连接';
                statusElement.style.color = connected ? 'green' : 'red';
            }
            isConnected = connected;
        }
        
        // 更新ATU数据显示
        function updateAtuDisplay(data) {
            if (data.power !== undefined) {
                document.getElementById('power-value').textContent = data.power;
            }
            if (data.swr !== undefined) {
                document.getElementById('swr-value').textContent = data.swr;
            }
            if (data.max_power !== undefined) {
                document.getElementById('max-power-value').textContent = data.max_power;
            }
            if (data.efficiency !== undefined) {
                document.getElementById('efficiency-value').textContent = data.efficiency;
            }
        }
        
        // 解析ATU二进制数据
        function parseAtuBinaryData(data) {
            try {
                if (data.length < 10) {
                    log('ATU数据长度不足: ' + data.length + ' 字节', 'warning');
                    return null;
                }
                
                // 解析二进制数据
                const flag = data[0];
                const cmd = data[1];
                const dataLen = data[2];
                
                log('解析ATU数据: flag=' + flag + ', cmd=' + cmd + ', len=' + dataLen, 'info');
                
                // 检查是否为电表数据 (SCMD_METER_STATUS = 2)
                if (cmd === 2 && dataLen >= 6) {
                    // 解析功率和SWR数据
                    const swr = (data[5] << 8) | data[4];
                    const fwdPower = (data[7] << 8) | data[6];  // 正向功率
                    const maxPower = (data[9] << 8) | data[8];  // 最大功率
                    
                    // 处理SWR值格式
                    const displaySwr = swr >= 100 ? swr / 100.0 : swr;
                    
                    // 计算传输效率
                    const efficiency = maxPower > 0 ? Math.min(100, (fwdPower / maxPower) * 100) : 0;
                    
                    const result = {
                        power: fwdPower,
                        swr: parseFloat(displaySwr.toFixed(2)),
                        max_power: maxPower,
                        efficiency: parseFloat(efficiency.toFixed(1))
                    };
                    
                    log('解析结果: ' + JSON.stringify(result), 'success');
                    return result;
                }
                
                log('未识别的ATU数据格式', 'warning');
                return null;
            } catch (error) {
                log('ATU数据解析错误: ' + error, 'error');
                return null;
            }
        }
        
        // 直接连接ATU设备
        function connectDirect() {
            if (isConnected) {
                log('已经连接到ATU设备', 'warning');
                return;
            }
            
            // 使用WSS协议以匹配HTTPS页面
            const serverUrl = 'wss://192.168.1.63:60001/';
            log('尝试直接连接到ATU设备: ' + serverUrl, 'info');
            
            try {
                atuSocket = new WebSocket(serverUrl);
                atuSocket.binaryType = 'arraybuffer';  // 设置二进制数据类型
                
                atuSocket.onopen = () => {
                    log('WebSocket连接已建立', 'success');
                    updateConnectionStatus(true);
                    
                    // 连接成功后立即发送同步命令
                    setTimeout(() => {
                        sendDirectSync();
                    }, 1000);
                };
                
                atuSocket.onclose = (event) => {
                    log(`WebSocket连接已关闭，代码: ${event.code}, 原因: ${event.reason}`, 'warning');
                    updateConnectionStatus(false);
                };
                
                atuSocket.onerror = (error) => {
                    log('WebSocket错误: ' + JSON.stringify(error), 'error');
                    updateConnectionStatus(false);
                };
                
                atuSocket.onmessage = (event) => {
                    messageCount++;
                    log('收到消息 #' + messageCount, 'info');
                    
                    if (event.data instanceof ArrayBuffer) {
                        const data = new Uint8Array(event.data);
                        log('收到二进制数据: ' + Array.from(data).join(', '), 'info');
                        
                        // 解析ATU数据
                        const parsedData = parseAtuBinaryData(data);
                        if (parsedData) {
                            log('解析ATU数据成功', 'success');
                            updateAtuDisplay(parsedData);
                        }
                    } else {
                        log('收到非二进制数据: ' + event.data, 'warning');
                    }
                };
            } catch (error) {
                log('WebSocket连接失败: ' + error, 'error');
                updateConnectionStatus(false);
            }
        }
        
        // 发送同步命令
        function sendDirectSync() {
            if (!isConnected || !atuSocket) {
                log('无法发送同步命令: 未连接', 'warning');
                return;
            }
            
            if (atuSocket.readyState !== WebSocket.OPEN) {
                log('无法发送同步命令: 连接未打开', 'warning');
                return;
            }
            
            try {
                // ATU同步命令: [0xFF, 0x01, 0x00]
                const syncCommand = new Uint8Array([0xFF, 0x01, 0x00]);
                atuSocket.send(syncCommand);
                log('已发送同步命令', 'info');
            } catch (error) {
                log('发送同步命令失败: ' + error, 'error');
            }
        }
        
        // 断开WebSocket连接
        function disconnectDirect() {
            if (atuSocket) {
                atuSocket.close();
                log('已请求断开WebSocket连接', 'info');
            } else {
                log('没有活动的WebSocket连接', 'warning');
            }
        }
        
        // 清空日志
        function clearLog() {
            document.getElementById('log-content').innerHTML = '';
            log('日志已清空', 'info');
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            log('页面已加载', 'info');
            
            // 2秒轮询机制
            setInterval(() => {
                if (isConnected) {
                    sendDirectSync();
                }
            }, 2000);
        });
    </script>
</body>
</html>
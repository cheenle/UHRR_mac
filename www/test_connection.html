<!DOCTYPE html>
<html>
<head>
    <title>连接测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; }
        #log { height: 400px; overflow-y: scroll; background: #f8f9fa; padding: 10px; }
    </style>
</head>
<body>
    <h1>WebSocket连接测试</h1>

    <div class="test info">
        <h3>当前页面信息</h3>
        <p>协议: <span id="protocol"></span></p>
        <p>主机: <span id="host"></span></p>
        <p>端口: <span id="port"></span></p>
        <p>完整URL: <span id="full-url"></span></p>
    </div>

    <div class="test">
        <h3>WebSocket连接测试</h3>
        <button onclick="testWSConnection('WSCTRX')">测试控制WebSocket (WSCTRX)</button>
        <button onclick="testWSConnection('WSaudioRX')">测试RX音频WebSocket (WSaudioRX)</button>
        <button onclick="testWSConnection('WSaudioTX')">测试TX音频WebSocket (WSaudioTX)</button>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <div class="test">
        <h3>连接日志</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testWSConnection(endpoint) {
            // 尝试ws://协议（如果wss://失败）
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = protocol + '//' + window.location.host + '/' + endpoint;

            log(`尝试连接到: ${wsUrl}`, 'info');

            try {
                const ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    log(`${endpoint} 连接成功!`, 'success');
                    // 发送测试消息
                    try {
                        if (endpoint === 'WSCTRX') {
                            ws.send('getFreq');
                        }
                    } catch (error) {
                        log(`发送测试消息失败: ${error}`, 'error');
                    }
                };

                ws.onmessage = function(event) {
                    log(`${endpoint} 收到消息: ${event.data}`, 'success');
                };

                ws.onerror = function(error) {
                    log(`${endpoint} 连接失败: ${error}`, 'error');
                };

                ws.onclose = function(event) {
                    log(`${endpoint} 连接关闭 (code: ${event.code}, reason: ${event.reason})`, 'info');
                };

                // 超时处理
                setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        log(`${endpoint} 连接超时`, 'error');
                        ws.close();
                    }
                }, 5000);

            } catch (error) {
                log(`创建WebSocket失败: ${error}`, 'error');
            }
        }

        // 页面加载时显示信息
        window.onload = function() {
            document.getElementById('protocol').textContent = window.location.protocol;
            document.getElementById('host').textContent = window.location.hostname;
            document.getElementById('port').textContent = window.location.port || '默认端口';
            document.getElementById('full-url').textContent = window.location.href;

            log('页面加载完成', 'info');
        };
    </script>
</body>
</html>


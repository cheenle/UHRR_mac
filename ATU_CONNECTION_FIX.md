# ATU连接错误修复指南

## 问题描述

ATU诊断工具显示："连接错误，请检查设备是否在线"

## 🔍 问题原因分析

这个错误通常由以下原因引起：

### 1. **端口配置错误** (最常见)
- ATU设备使用非标准端口
- WebSocket服务端口配置不正确

### 2. **服务未启动**
- ATU设备的WebSocket服务未运行
- 需要先访问Web界面激活服务

### 3. **网络问题**
- 防火墙阻止连接
- 网络配置问题

## 🛠️ 解决步骤

### 第一步：使用增强诊断工具

访问：`http://localhost:8080/atu_diagnostic.html`

1. **点击"扫描端口"按钮**
   - 工具会自动扫描常用端口
   - 查看哪些端口显示为"开放"
   - 自动建议最佳端口配置

2. **查看诊断日志**
   - 观察详细的连接过程
   - 识别具体的错误原因

### 第二步：手动端口测试

如果自动扫描发现其他端口：

1. 在端口输入框中修改端口号
2. 点击"测试WebSocket连接"
3. 查看连接状态和错误信息

### 第三步：激活ATU服务

有些ATU设备需要先访问Web界面激活WebSocket服务：

1. **打开浏览器访问**：`http://192.168.1.12/`
2. 浏览ATU设备的主界面
3. 查看是否有"实时数据"、"WebSocket"或"远程监控"等设置
4. 启用相关功能后重新测试连接

### 第四步：常见端口尝试

按照以下顺序测试端口：

| 端口 | 服务类型 | 说明 |
|------|----------|------|
| 80   | HTTP     | 网页界面（已确认可用） |
| 81   | WebSocket| 当前配置（连接被拒绝） |
| 8080 | HTTP/WS  | 常用备选端口 |
| 8081 | WebSocket| 备选WebSocket端口 |
| 23   | Telnet   | 串口控制端口 |

## 📊 诊断工具功能

### 界面元素说明

- **🟢 绿色指示器**：连接成功
- **🔴 红色指示器**：连接失败
- **📊 实时数据区**：显示功率和SWR值
- **📝 调试日志**：技术细节和错误信息

### 测试按钮功能

1. **扫描端口**：自动检测所有常用端口
2. **测试HTTP连接**：验证网页访问
3. **测试WebSocket连接**：验证实时数据连接
4. **开始监控**：持续监控数据流

## 🔧 高级故障排除

### 检查ATU设备设置

1. 访问设备Web界面：`http://192.168.1.12/`
2. 查找以下设置项：
   - "网络设置" 或 "Network Settings"
   - "端口配置" 或 "Port Configuration"
   - "实时数据" 或 "Real-time Data"
   - "WebSocket" 或 "Remote Access"

3. 确认WebSocket端口配置
4. 检查是否有启用选项

### 网络环境检查

1. **确认设备在线**：
   ```bash
   ping 192.168.1.12
   ```

2. **测试端口访问**：
   ```bash
   curl -I http://192.168.1.12/
   ```

3. **检查防火墙**：
   - 确认路由器防火墙设置
   - 检查电脑防火墙是否阻止端口

### 查看设备文档

1. 查看ATU设备说明书
2. 查找"WebSocket"、"实时监控"或"远程访问"章节
3. 确认正确的端口号和激活方法

## 💡 备用解决方案

如果WebSocket一直无法连接，可以考虑：

### 方案1：HTTP轮询
- 定期通过HTTP请求获取数据
- 不需要WebSocket连接
- 实现简单但实时性稍差

### 方案2：串口连接
- 如果设备支持串口通信
- 直接通过串口获取数据
- 需要额外的硬件连接

### 方案3：MQTT或其他协议
- 查看设备是否支持MQTT、TCP或其他协议
- 可能需要不同的客户端实现

## 📞 获取帮助

如果问题依然存在，请提供以下信息：

1. **ATU设备型号和固件版本**
2. **诊断工具的详细错误日志**
3. **设备Web界面的截图**
4. **网络配置信息**

## 🎯 快速诊断命令

在终端中运行以下命令快速诊断：

```bash
# 测试设备连通性
ping -c 3 192.168.1.12

# 测试常用端口
for port in 80 81 8080 8081; do
  echo "测试端口 $port:"
  curl -m 3 http://192.168.1.12:$port/ >/dev/null 2>&1 && echo "  HTTP: 开放" || echo "  HTTP: 关闭"
done
```

## 📋 故障排除清单

- [ ] 设备可以ping通
- [ ] 端口80可以访问
- [ ] 已尝试端口扫描
- [ ] 已访问设备Web界面
- [ ] 已检查设备设置
- [ ] 已尝试不同端口号
- [ ] 防火墙设置正确

按照以上步骤逐一检查，通常能解决问题。请先尝试端口扫描功能！

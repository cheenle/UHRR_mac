#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import tornado.httpserver
import ssl
import tornado.ioloop
import tornado.web
import tornado.websocket
import threading
import time
import datetime
import configparser
import sys
import logging
import socket
import struct
import json
import websocket
import json
import shutil

# è®¾ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('atu_server_websocket_debug.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger('ATU_SERVER_WEBSOCKET')

# å…¨å±€å˜é‡
ATU_DEVICE_IP = '192.168.1.63'  # ç›´æ¥è®¾ç½®ATUè®¾å¤‡IPåœ°å€
ATU_DEVICE_PORT = 60001
ATU_SERVER_PORT = 8889  # æ”¹å›åŸæ¥çš„ç«¯å£ï¼Œé¿å…ä¸UHRRæœåŠ¡å™¨å†²çª

# é¢„è®¾é¢‘ç‡é…ç½® - åœ¨è¿™äº›é¢‘ç‡é™„è¿‘ä¼šè‡ªåŠ¨åº”ç”¨ATUå‚æ•°
PRESET_FREQUENCIES = {
    7.050: {'sw': 0, 'inductor': 10, 'capacitor': 20},  # 7MHzé¢‘æ®µ
    14.100: {'sw': 0, 'inductor': 15, 'capacitor': 25},  # 14MHzé¢‘æ®µ
    21.100: {'sw': 1, 'inductor': 5, 'capacitor': 15},   # 21MHzé¢‘æ®µ
    28.100: {'sw': 1, 'inductor': 0, 'capacitor': 10}    # 28MHzé¢‘æ®µ
}

# ATUè®¾å¤‡è¿æ¥çŠ¶æ€
atu_device_connected = False
atu_ws_client = None

# WebSocketå®¢æˆ·ç«¯åˆ—è¡¨
atu_ws_clients = []

# å­˜å‚¨ä¼˜åŒ–çš„è°ƒè°å‚æ•°
optimized_tuning_configs = {}  # é¢‘ç‡ -> æœ€ä½³è°ƒè°å‚æ•°çš„æ˜ å°„

# å­˜å‚¨é…ç½®æ–‡ä»¶è·¯å¾„
CONFIG_FILE = 'atu_optimized_configs.json'

# å­˜å‚¨æœ€è¿‘çš„ç”µè¡¨æ•°æ®å’Œç»§ç”µå™¨çŠ¶æ€æ•°æ®ï¼Œç”¨äºå…³è”ä¿å­˜é…ç½®
latest_meter_data = None
latest_relay_data = None

# ATUå‘½ä»¤å®šä¹‰
SCMD_FLAG = 0xFF
SCMD_SYNC = 1
SCMD_METER_STATUS = 2
SCMD_TUNE_STATUS = 3
SCMD_TUNE_MODE = 4
SCMD_RELAY_STATUS = 5

# å®šä¹‰ä¸»è¦æ³¢æ®µçš„ä¸­å¿ƒé¢‘ç‡
BAND_CENTERS = {
    '160m': 1.850,
    '80m': 3.550,
    '40m': 7.050,  # æ‚¨æŒ‡å®šçš„40mæ³¢æ®µä¸­å¿ƒé¢‘ç‡
    '30m': 10.100,
    '20m': 14.100,  # æ‚¨æŒ‡å®šçš„20mæ³¢æ®µä¸­å¿ƒé¢‘ç‡
    '17m': 18.100,
    '15m': 21.100,  # æ‚¨æŒ‡å®šçš„15mæ³¢æ®µä¸­å¿ƒé¢‘ç‡
    '12m': 24.900,
    '10m': 28.100   # æ‚¨æŒ‡å®šçš„10mæ³¢æ®µä¸­å¿ƒé¢‘ç‡
}

# å®šä¹‰æ¯ä¸ªæ³¢æ®µçš„é»˜è®¤ATUå‚æ•°ï¼ˆå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
DEFAULT_BAND_CONFIGS = {
    '160m': {'network': 'LC', 'inductor': 60, 'capacitor': 80},
    '80m': {'network': 'LC', 'inductor': 40, 'capacitor': 60},
    '40m': {'network': 'LC', 'inductor': 30, 'capacitor': 40},
    '30m': {'network': 'LC', 'inductor': 25, 'capacitor': 30},
    '20m': {'network': 'LC', 'inductor': 20, 'capacitor': 25},
    '17m': {'network': 'LC', 'inductor': 15, 'capacitor': 20},
    '15m': {'network': 'LC', 'inductor': 12, 'capacitor': 15},
    '12m': {'network': 'LC', 'inductor': 10, 'capacitor': 12},
    '10m': {'network': 'LC', 'inductor': 8, 'capacitor': 10}
}

# å½“å‰é¢‘ç‡
current_frequency = 0

# åŠ è½½è°ƒè°é…ç½®ï¼ˆå¸¦å¤‡ä»½æ¢å¤ï¼‰
def load_optimized_configs():
    """ä»æ–‡ä»¶åŠ è½½å­˜å‚¨çš„è°ƒè°é…ç½®"""
    global optimized_tuning_configs
    try:
        if os.path.exists(CONFIG_FILE):
            with open(CONFIG_FILE, 'r') as f:
                optimized_tuning_configs = json.load(f)
            logger.info(f"âœ… å·²åŠ è½½ {len(optimized_tuning_configs)} ä¸ªå­˜å‚¨çš„è°ƒè°é…ç½®")
        elif os.path.exists(f"{CONFIG_FILE}.backup"):
            # å°è¯•ä»å¤‡ä»½æ–‡ä»¶åŠ è½½
            logger.info("âš ï¸ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•ä»å¤‡ä»½æ–‡ä»¶åŠ è½½")
            with open(f"{CONFIG_FILE}.backup", 'r') as f:
                optimized_tuning_configs = json.load(f)
            # æ¢å¤å¤‡ä»½æ–‡ä»¶
            shutil.copy2(f"{CONFIG_FILE}.backup", CONFIG_FILE)
            logger.info(f"âœ… å·²ä»å¤‡ä»½æ–‡ä»¶æ¢å¤å¹¶åŠ è½½ {len(optimized_tuning_configs)} ä¸ªè°ƒè°é…ç½®")
        else:
            logger.info("ğŸ“ è°ƒè°é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶")
    except Exception as e:
        logger.error(f"âŒ åŠ è½½è°ƒè°é…ç½®å¤±è´¥: {e}")
        optimized_tuning_configs = {}

# ä¿å­˜è°ƒè°é…ç½®åˆ°æ–‡ä»¶
def save_optimized_configs():
    """ä¿å­˜è°ƒè°é…ç½®åˆ°æ–‡ä»¶"""
    global optimized_tuning_configs
    try:
        # åˆ›å»ºå¤‡ä»½æ–‡ä»¶ï¼ˆå¦‚æœåŸæ–‡ä»¶å­˜åœ¨ï¼‰
        if os.path.exists(CONFIG_FILE):
            backup_file = f"{CONFIG_FILE}.backup"
            shutil.copy2(CONFIG_FILE, backup_file)
            logger.info(f"ğŸ”„ å·²åˆ›å»ºé…ç½®æ–‡ä»¶å¤‡ä»½: {backup_file}")
        
        with open(CONFIG_FILE, 'w') as f:
            json.dump(optimized_tuning_configs, f, indent=2)
        logger.info(f"âœ… å·²ä¿å­˜ {len(optimized_tuning_configs)} ä¸ªè°ƒè°é…ç½®åˆ°æ–‡ä»¶")
    except Exception as e:
        logger.error(f"âŒ ä¿å­˜è°ƒè°é…ç½®å¤±è´¥: {e}")

# åœ¨ç¨‹åºå¯åŠ¨æ—¶åŠ è½½é…ç½®
load_optimized_configs()

# è·å–å½“å‰é¢‘ç‡
def get_current_frequency():
    """è·å–å½“å‰é¢‘ç‡"""
    global current_frequency
    return current_frequency

# æ›´æ–°å½“å‰é¢‘ç‡
def update_current_frequency(freq):
    """æ›´æ–°å½“å‰é¢‘ç‡"""
    global current_frequency
    current_frequency = freq
    logger.info(f"ğŸ“¡ å½“å‰é¢‘ç‡æ›´æ–°ä¸º: {freq/1000000:.3f} MHz")


class AtuWebSocketClient:
    """ATUè®¾å¤‡WebSocketå®¢æˆ·ç«¯"""
    
    def __init__(self):
        self.ws = None
        self.running = True
        self.connected = False
        
    def connect(self):
        """è¿æ¥åˆ°ATUè®¾å¤‡WebSocket"""
        global atu_device_connected
        
        ws_url = f"ws://{ATU_DEVICE_IP}:{ATU_DEVICE_PORT}/"
        logger.info(f"å°è¯•è¿æ¥ATUè®¾å¤‡WebSocket: {ws_url}")
        
        try:
            self.ws = websocket.WebSocketApp(ws_url,
                                            on_open=self.on_open,
                                            on_message=self.on_message,
                                            on_error=self.on_error,
                                            on_close=self.on_close)
            
            # åœ¨åå°çº¿ç¨‹ä¸­è¿è¡ŒWebSocket
            def run_ws():
                # æ·»åŠ è¿æ¥è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
                reconnect_count = 0
                max_reconnect_attempts = 5
                
                while self.running and reconnect_count < max_reconnect_attempts:
                    try:
                        logger.info(f"å¯åŠ¨WebSocketè¿æ¥ (å°è¯• {reconnect_count + 1}/{max_reconnect_attempts})")
                        self.ws.run_forever(
                            ping_interval=30,  # æ¯30ç§’å‘é€ping
                            ping_timeout=10,   # pingè¶…æ—¶10ç§’
                            reconnect=5        # è‡ªåŠ¨é‡è¿é—´éš”5ç§’
                        )
                        
                        # å¦‚æœæ­£å¸¸é€€å‡ºä¸”ä»åœ¨è¿è¡Œï¼Œå¯èƒ½æ˜¯è¿æ¥æ–­å¼€ï¼Œéœ€è¦é‡è¿
                        if self.running:
                            logger.info("WebSocketè¿æ¥æ–­å¼€ï¼Œå‡†å¤‡é‡è¿...")
                            reconnect_count += 1
                            if reconnect_count < max_reconnect_attempts:
                                time.sleep(5)
                        else:
                            break
                            
                    except Exception as e:
                        logger.error(f"WebSocketè¿è¡Œæ—¶é”™è¯¯: {e}")
                        reconnect_count += 1
                        if reconnect_count < max_reconnect_attempts and self.running:
                            logger.info(f"ç­‰å¾…5ç§’åé‡è¯•... (å°è¯• {reconnect_count + 1}/{max_reconnect_attempts})")
                            time.sleep(5)
                        else:
                            break
                
                if reconnect_count >= max_reconnect_attempts:
                    logger.error("è¾¾åˆ°æœ€å¤§é‡è¿å°è¯•æ¬¡æ•°ï¼Œåœæ­¢é‡è¿")
            
            ws_thread = threading.Thread(target=run_ws)
            ws_thread.daemon = True
            ws_thread.start()
            
        except Exception as e:
            logger.error(f"åˆ›å»ºWebSocketè¿æ¥å¤±è´¥: {e}")
    
    def on_open(self, ws):
        """WebSocketè¿æ¥æ‰“å¼€"""
        global atu_device_connected
        
        logger.info("âœ“ ATUè®¾å¤‡WebSocketè¿æ¥æˆåŠŸ")
        self.connected = True
        atu_device_connected = True
        
        # å‘é€è¿æ¥æˆåŠŸé€šçŸ¥
        self.broadcast_to_clients({
            'type': 'status',
            'message': 'ATUè®¾å¤‡å·²è¿æ¥',
            'connected': True
        })
        
        # å‘é€åŒæ­¥å‘½ä»¤
        self.send_sync()
        
        # å¯åŠ¨æ•°æ®è¯·æ±‚å¾ªç¯
        self.start_data_request_loop()
    
    def on_message(self, ws, message):
        """æ¥æ”¶åˆ°ATUè®¾å¤‡æ¶ˆæ¯"""
        try:
            # è§£æäºŒè¿›åˆ¶æ•°æ®
            if isinstance(message, bytes):
                data = bytearray(message)
                logger.debug(f"æ¥æ”¶åˆ°ATUæ•°æ®: {len(data)} å­—èŠ‚")
                
                # è§£ææ•°æ®
                parsed_data = self.parse_atu_data(data)
                if parsed_data:
                    # è½¬å‘ç»™WebSocketå®¢æˆ·ç«¯
                    self.broadcast_to_clients({
                        'type': 'data',
                        'data': parsed_data,
                        'timestamp': datetime.datetime.now().isoformat()
                    })
            
        except Exception as e:
            logger.error(f"å¤„ç†ATUæ¶ˆæ¯é”™è¯¯: {e}")
    
    def on_error(self, ws, error):
        """WebSocketé”™è¯¯"""
        global atu_device_connected
        logger.error(f"ATUè®¾å¤‡WebSocketé”™è¯¯: {error}")
        self.connected = False
        atu_device_connected = False
        
        # å‘é€é”™è¯¯é€šçŸ¥
        self.broadcast_to_clients({
            'type': 'status',
            'message': 'ATUè®¾å¤‡è¿æ¥é”™è¯¯',
            'connected': False,
            'error': str(error)
        })
    
    def on_close(self, ws, close_status_code, close_msg):
        """WebSocketè¿æ¥å…³é—­"""
        global atu_device_connected
        
        logger.warning(f"ATUè®¾å¤‡WebSocketè¿æ¥å…³é—­ (çŠ¶æ€ç : {close_status_code}, æ¶ˆæ¯: {close_msg})")
        self.connected = False
        atu_device_connected = False
        
        # å‘é€è¿æ¥æ–­å¼€é€šçŸ¥
        self.broadcast_to_clients({
            'type': 'status',
            'message': 'ATUè®¾å¤‡è¿æ¥æ–­å¼€',
            'connected': False,
            'close_status_code': close_status_code,
            'close_msg': close_msg
        })
        
        # å°è¯•é‡æ–°è¿æ¥ï¼ˆä½¿ç”¨çº¿ç¨‹é¿å…é˜»å¡ï¼‰
        if self.running:
            logger.info("5ç§’åå°è¯•é‡æ–°è¿æ¥...")
            reconnect_thread = threading.Thread(target=self._reconnect_worker)
            reconnect_thread.daemon = True
            reconnect_thread.start()
    
    def _reconnect_worker(self):
        """é‡è¿å·¥ä½œçº¿ç¨‹"""
        try:
            time.sleep(5)
            if self.running:
                self.connect()
        except Exception as e:
            logger.error(f"é‡è¿è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
    
    def parse_atu_data(self, data):
        """è§£æATUè®¾å¤‡æ•°æ®"""
        # å£°æ˜æ‰€æœ‰éœ€è¦çš„å…¨å±€å˜é‡
        global latest_meter_data, current_frequency, latest_relay_data
        
        try:
            if len(data) < 10:
                logger.info(f"ATUæ•°æ®é•¿åº¦ä¸è¶³: {len(data)} å­—èŠ‚")
                return None
            
            # è§£æäºŒè¿›åˆ¶æ•°æ®
            flag = data[0]
            cmd = data[1]
            data_len = data[2]
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºç”µè¡¨æ•°æ® (SCMD_METER_STATUS = 2)
            if cmd == SCMD_METER_STATUS and data_len >= 6:
                # è§£æåŠŸç‡å’ŒSWRæ•°æ®
                # æ­£ç¡®åç§»ï¼šSWR(4-5), åŠŸç‡(6-7), æœ€å¤§åŠŸç‡(8-9)
                swr = struct.unpack('<H', bytes(data[4:6]))[0]
                fwd_power = struct.unpack('<H', bytes(data[6:8]))[0]  # æ­£å‘åŠŸç‡
                max_power = struct.unpack('<H', bytes(data[8:10]))[0]  # æœ€å¤§åŠŸç‡
                
                # å¤„ç†SWRå€¼æ ¼å¼
                display_swr = swr
                if swr >= 100:
                    display_swr = swr / 100.0
                
                # è®¡ç®—ä¼ è¾“æ•ˆç‡
                efficiency = 0
                if max_power > 0:
                    efficiency = min(100, (fwd_power / max_power) * 100)
                
                parsed_data = {
                    'power': fwd_power,
                    'swr': round(display_swr, 2),
                    'max_power': max_power,
                    'efficiency': round(efficiency, 1)
                }
                
                logger.info(f"ğŸ“¡ ATUç”µè¡¨æ•°æ®: åŠŸç‡={fwd_power}W, SWR={display_swr}, æœ€å¤§åŠŸç‡={max_power}W, æ•ˆç‡={efficiency}%")
                
                # å­˜å‚¨æœ€æ–°çš„ç”µè¡¨æ•°æ®
                latest_meter_data = {
                    'power': fwd_power,
                    'swr': display_swr,
                    'max_power': max_power,
                    'efficiency': efficiency
                }
                
                # å¦‚æœæœ‰åŠŸç‡è¾“å‡ºä¸”SWRè¾ƒä½ï¼Œå°è¯•ä¿å­˜ä¸ºä¼˜åŒ–é…ç½®
                if fwd_power > 0 and current_frequency > 0:
                    freq_mhz = current_frequency / 1000000.0  # è½¬æ¢ä¸ºMHz
                    # åªæœ‰å½“SWRå°äº2.0æ—¶æ‰è€ƒè™‘ä¿å­˜é…ç½®
                    if display_swr < 2.0:
                        # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å­˜å‚¨çš„é…ç½®
                        existing_config = self.get_optimized_config(freq_mhz)
                        should_save = False
                        
                        if existing_config:
                            # å¦‚æœå½“å‰SWRæ¯”å­˜å‚¨çš„SWRæ›´å¥½ï¼Œåˆ™æ›´æ–°é…ç½®
                            stored_swr = existing_config.get('swr', 999)
                            if display_swr < stored_swr:
                                should_save = True
                                logger.info(f"ğŸ”„ é¢‘ç‡ {freq_mhz:.3f}MHz çš„SWR ({display_swr}) ä¼˜äºå­˜å‚¨çš„SWR ({stored_swr})ï¼Œå°†æ›´æ–°é…ç½®")
                        else:
                            # æ²¡æœ‰å­˜å‚¨çš„é…ç½®ï¼Œä¿å­˜å½“å‰é…ç½®
                            should_save = True
                            logger.info(f"ğŸ’¾ é¢‘ç‡ {freq_mhz:.3f}MHz æ²¡æœ‰å­˜å‚¨çš„é…ç½®ï¼Œå°†ä¿å­˜å½“å‰é…ç½®")
                        
                        if should_save:
                            # æŸ¥æ‰¾æœ€è¿‘çš„ç»§ç”µå™¨çŠ¶æ€æ•°æ®
                            if latest_relay_data:
                                logger.info(f"ğŸ’¾ ä¿å­˜é¢‘ç‡ {freq_mhz:.3f}MHz çš„ä¼˜åŒ–é…ç½®: SWR={display_swr}, ç½‘ç»œ={latest_relay_data['network']}, ç”µæ„Ÿ={latest_relay_data['inductor']}, ç”µå®¹={latest_relay_data['capacitor']}")
                                self.update_optimized_config(freq_mhz, display_swr, latest_relay_data)
                
                return parsed_data
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºç»§ç”µå™¨çŠ¶æ€æ•°æ® (SCMD_RELAY_STATUS = 5)
            elif cmd == SCMD_RELAY_STATUS and data_len >= 7:
                # è§£æç»§ç”µå™¨çŠ¶æ€æ•°æ®
                sw = data[3]  # ç½‘ç»œå¼€å…³
                ind = data[4]  # ç”µæ„Ÿç»§ç”µå™¨
                cap = data[5]  # ç”µå®¹ç»§ç”µå™¨
                
                # å®‰å…¨åœ°è§£æç”µæ„Ÿå’Œç”µå®¹å€¼
                L = 0
                C = 0
                if len(data) >= 8:
                    L = struct.unpack('<H', bytes(data[6:8]))[0]  # ç”µæ„Ÿå€¼
                    # è½¬æ¢ç”µæ„Ÿå€¼ä¸ºÎ¼H (ATUè®¾å¤‡è¿”å›çš„æ˜¯100å€çš„å€¼)
                    L = L / 100.0
                if len(data) >= 10:
                    C = struct.unpack('<H', bytes(data[8:10]))[0]  # ç”µå®¹å€¼
                
                parsed_data = {
                    'relay': {
                        'network': 'CL' if sw == 1 else 'LC',
                        'inductor': ind,
                        'capacitor': cap,
                        'inductance': L,
                        'capacitance': C
                    }
                }
                
                logger.info(f"ğŸ”§ ATUç»§ç”µå™¨çŠ¶æ€: ç½‘ç»œ={parsed_data['relay']['network']}, ç”µæ„Ÿ={L}Î¼H, ç”µå®¹={C}pF")
                
                # å­˜å‚¨æœ€æ–°çš„ç»§ç”µå™¨æ•°æ®
                latest_relay_data = parsed_data['relay']
                
                return parsed_data
            
            return None
            
        except Exception as e:
            logger.error(f"è§£æATUæ•°æ®é”™è¯¯: {e}")
            return None
    
    def send_sync(self):
        """å‘é€åŒæ­¥å‘½ä»¤åˆ°ATUè®¾å¤‡"""
        if self.connected and self.ws:
            try:
                # ATUåŒæ­¥å‘½ä»¤: [0xFF, 0x01, 0x00]
                sync_command = bytearray([SCMD_FLAG, SCMD_SYNC, 0x00])
                self.ws.send(sync_command, opcode=websocket.ABNF.OPCODE_BINARY)
            except Exception as e:
                logger.error(f"å‘é€åŒæ­¥å‘½ä»¤å¤±è´¥: {e}")
    
    def send_tune_status(self, status):
        """å‘é€è°ƒè°çŠ¶æ€å‘½ä»¤"""
        if self.connected and self.ws:
            try:
                # ATUè°ƒè°çŠ¶æ€å‘½ä»¤: [0xFF, 0x03, 0x01, status]
                tune_command = bytearray([SCMD_FLAG, SCMD_TUNE_STATUS, 0x01, status])
                self.ws.send(tune_command, opcode=websocket.ABNF.OPCODE_BINARY)
                logger.info(f"ğŸ“¤ å‘é€è°ƒè°çŠ¶æ€å‘½ä»¤: {status}")
            except Exception as e:
                logger.error(f"å‘é€è°ƒè°çŠ¶æ€å‘½ä»¤å¤±è´¥: {e}")
    
    def send_tune_mode(self, mode):
        """å‘é€è°ƒè°æ¨¡å¼å‘½ä»¤"""
        if self.connected and self.ws:
            try:
                # ATUè°ƒè°æ¨¡å¼å‘½ä»¤: [0xFF, 0x04, 0x01, mode]
                tune_command = bytearray([SCMD_FLAG, SCMD_TUNE_MODE, 0x01, mode])
                self.ws.send(tune_command, opcode=websocket.ABNF.OPCODE_BINARY)
                logger.info(f"ğŸ“¤ å‘é€è°ƒè°æ¨¡å¼å‘½ä»¤: {mode}")
            except Exception as e:
                logger.error(f"å‘é€è°ƒè°æ¨¡å¼å‘½ä»¤å¤±è´¥: {e}")
    
    def send_relay_status(self, sw, ind, cap):
        """å‘é€ç»§ç”µå™¨çŠ¶æ€å‘½ä»¤"""
        if self.connected and self.ws:
            try:
                # ATUç»§ç”µå™¨çŠ¶æ€å‘½ä»¤: [0xFF, 0x05, 0x03, sw, ind, cap]
                relay_command = bytearray([SCMD_FLAG, SCMD_RELAY_STATUS, 0x03, sw, ind, cap])
                self.ws.send(relay_command, opcode=websocket.ABNF.OPCODE_BINARY)
                logger.info(f"ğŸ“¤ å‘é€ç»§ç”µå™¨çŠ¶æ€å‘½ä»¤: ç½‘ç»œ={sw}, ç”µæ„Ÿ={ind}, ç”µå®¹={cap}")
            except Exception as e:
                logger.error(f"å‘é€ç»§ç”µå™¨çŠ¶æ€å‘½ä»¤å¤±è´¥: {e}")
    
    def start_data_request_loop(self):
        """å¯åŠ¨æ•°æ®è¯·æ±‚å¾ªç¯"""
        def data_request_loop():
            error_count = 0
            max_errors = 10  # æœ€å¤§è¿ç»­é”™è¯¯æ¬¡æ•°
            health_check_count = 0  # å¥åº·æ£€æŸ¥è®¡æ•°å™¨
            
            while self.running and self.connected:
                try:
                    self.send_sync()
                    
                    # æ¯10æ¬¡æ•°æ®è¯·æ±‚è¿›è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
                    health_check_count += 1
                    if health_check_count >= 10:
                        health_check_count = 0
                        # æ£€æŸ¥è¿æ¥çŠ¶æ€
                        if not self.connected:
                            global atu_device_connected
                            logger.warning("æ£€æµ‹åˆ°è¿æ¥çŠ¶æ€ä¸ä¸€è‡´ï¼Œå°è¯•é‡æ–°åŒæ­¥")
                            self.connected = True  # é‡æ–°è®¾ç½®è¿æ¥çŠ¶æ€
                            atu_device_connected = True
                    
                    time.sleep(0.2)  # æ¯200mså‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œæé«˜æ›´æ–°é¢‘ç‡
                    error_count = 0  # é‡ç½®é”™è¯¯è®¡æ•°
                except Exception as e:
                    error_count += 1
                    logger.error(f"æ•°æ®è¯·æ±‚å¾ªç¯é”™è¯¯ ({error_count}/{max_errors}): {e}")
                    
                    # å¦‚æœè¿ç»­é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œæ–­å¼€è¿æ¥å¹¶å°è¯•é‡è¿
                    if error_count >= max_errors:
                        global atu_device_connected
                        logger.error("è¿ç»­é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œæ–­å¼€ATUè®¾å¤‡è¿æ¥")
                        self.connected = False
                        atu_device_connected = False
                        
                        # å‘é€é”™è¯¯é€šçŸ¥
                        self.broadcast_to_clients({
                            "type": "status",
                            "message": "ATUè®¾å¤‡è¿æ¥ä¸ç¨³å®šï¼Œå·²æ–­å¼€è¿æ¥",
                            "connected": False,
                            "error": "è¿ç»­æ•°æ®è¯·æ±‚é”™è¯¯"
                        })                        
                        # å°è¯•é‡æ–°è¿æ¥
                        if self.running:
                            logger.info("5ç§’åå°è¯•é‡æ–°è¿æ¥...")
                            reconnect_thread = threading.Thread(target=self._reconnect_worker)
                            reconnect_thread.daemon = True
                            reconnect_thread.start()
                        break
                        
                    # çŸ­æš‚ç­‰å¾…åé‡è¯•
                    time.sleep(1)
        
        data_thread = threading.Thread(target=data_request_loop)
        data_thread.daemon = True
        data_thread.start()
    
    def broadcast_to_clients(self, message):
        """å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰WebSocketå®¢æˆ·ç«¯"""
        global atu_ws_clients
        
        # ä½¿ç”¨Tornadoçš„IOLoopæ¥å®‰å…¨åœ°å‘é€æ¶ˆæ¯
        import tornado.ioloop
        
        def send_message_in_loop():
            for client in atu_ws_clients[:]:  # ä½¿ç”¨å‰¯æœ¬é¿å…ä¿®æ”¹æ—¶è¿­ä»£
                try:
                    client.write_message(json.dumps(message))
                except Exception as e:
                    logger.error(f"å‘é€æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯å¤±è´¥: {e}")
                    # ç§»é™¤å¤±æ•ˆçš„å®¢æˆ·ç«¯
                    if client in atu_ws_clients:
                        atu_ws_clients.remove(client)
        
        # åœ¨Tornadoçš„äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œå‘é€æ“ä½œ
        try:
            loop = tornado.ioloop.IOLoop.current()
            if loop:
                loop.add_callback(send_message_in_loop)
            else:
                # å¦‚æœæ— æ³•è·å–äº‹ä»¶å¾ªç¯ï¼Œç›´æ¥å‘é€ï¼ˆå¯èƒ½åœ¨ä¸»çº¿ç¨‹ä¸­ï¼‰
                send_message_in_loop()
        except Exception as e:
            logger.error(f"æ·»åŠ å›è°ƒåˆ°äº‹ä»¶å¾ªç¯å¤±è´¥: {e}")
            # å›é€€åˆ°ç›´æ¥å‘é€
            send_message_in_loop()
    
    def update_optimized_config(self, frequency, swr, relay_data):
        """æ›´æ–°æŒ‡å®šé¢‘ç‡çš„ä¼˜åŒ–è°ƒè°é…ç½®"""
        global optimized_tuning_configs
        
        # æ ¼å¼åŒ–é¢‘ç‡ä¸º3ä½å°æ•°çš„å­—ç¬¦ä¸²ä½œä¸ºé”®
        freq_key = f"{frequency:.3f}"
        
        # å¦‚æœå½“å‰SWRæ¯”å­˜å‚¨çš„SWRæ›´å¥½ï¼Œåˆ™æ›´æ–°é…ç½®
        if freq_key in optimized_tuning_configs:
            stored_swr = optimized_tuning_configs[freq_key]['swr']
            if swr > stored_swr:
                logger.info(f"ğŸ”„ é¢‘ç‡ {freq_key}MHz çš„SWR ({swr}) ä¸ä¼˜äºå­˜å‚¨çš„SWR ({stored_swr})ï¼Œè·³è¿‡æ›´æ–°")
                return
        
        # æ›´æ–°é…ç½®
        optimized_tuning_configs[freq_key] = {
            'frequency': frequency,
            'swr': swr,
            'relay': relay_data,
            'timestamp': datetime.datetime.now().isoformat()
        }
        
        # ä¿å­˜åˆ°æ–‡ä»¶
        save_optimized_configs()
        logger.info(f"ğŸ’¾ å·²æ›´æ–°é¢‘ç‡ {freq_key}MHz çš„ä¼˜åŒ–é…ç½®: SWR={swr}, ç½‘ç»œ={relay_data.get('network')}, ç”µæ„Ÿ={relay_data.get('inductance')}Î¼H, ç”µå®¹={relay_data.get('capacitance')}pF")
    
    def get_optimized_config(self, frequency):
        """è·å–æŒ‡å®šé¢‘ç‡çš„ä¼˜åŒ–è°ƒè°é…ç½®"""
        freq_key = f"{frequency:.3f}"
        config = optimized_tuning_configs.get(freq_key)
        
        if config:
            # ç²¾ç¡®åŒ¹é…
            return config
        
        # å¦‚æœæ²¡æœ‰ç²¾ç¡®åŒ¹é…ï¼Œå°è¯•åœ¨é¢‘ç‡èŒƒå›´å†…æŸ¥æ‰¾è¿‘ä¼¼é…ç½®
        # æ‰¾åˆ°æœ€æ¥è¿‘çš„æ³¢æ®µä¸­å¿ƒ
        closest_band = None
        min_diff = float('inf')
        for band, center in BAND_CENTERS.items():
            diff = abs(frequency - center)
            if diff < min_diff:
                min_diff = diff
                closest_band = band
        
        # å¦‚æœé¢‘ç‡åœ¨æ³¢æ®µèŒƒå›´å†…ï¼ˆÂ±100kHzï¼‰ï¼ŒæŸ¥æ‰¾è¯¥æ³¢æ®µçš„é…ç½®
        if min_diff <= 0.1:  # 100kHzèŒƒå›´å†…
            for stored_freq_str, stored_config in optimized_tuning_configs.items():
                stored_freq = float(stored_freq_str)
                stored_band = None
                
                # ç¡®å®šå­˜å‚¨é…ç½®çš„æ³¢æ®µ
                for band, center in BAND_CENTERS.items():
                    if abs(stored_freq - center) <= 0.1:
                        stored_band = band
                        break
                
                # å¦‚æœå­˜å‚¨é…ç½®å’Œå½“å‰é¢‘ç‡åœ¨åŒä¸€æ³¢æ®µï¼Œè¿”å›å­˜å‚¨é…ç½®
                if stored_band == closest_band:
                    logger.info(f"ğŸ”„ åœ¨{closest_band}æ³¢æ®µæ‰¾åˆ°è¿‘ä¼¼é¢‘ç‡é…ç½®: {stored_freq:.3f}MHz -> {frequency:.3f}MHz")
                    return stored_config
        
        logger.info(f"ğŸ” é¢‘ç‡ {frequency:.3f}MHz æ²¡æœ‰åŒ¹é…çš„ä¼˜åŒ–é…ç½®")
        return None
    
    def apply_optimized_config(self, frequency):
        """åº”ç”¨æŒ‡å®šé¢‘ç‡çš„ä¼˜åŒ–è°ƒè°é…ç½®"""
        # é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„ä¼˜åŒ–é…ç½®
        config = self.get_optimized_config(frequency)
        if config:
            relay_data = config.get('relay', {})
            if relay_data:
                # å‘é€ç»§ç”µå™¨çŠ¶æ€å‘½ä»¤
                network = relay_data.get('network', 'LC')
                sw = 1 if network == 'CL' else 0  # CLç½‘ç»œä¸º1ï¼ŒLCç½‘ç»œä¸º0
                inductance = relay_data.get('inductor', 0)
                capacitance = relay_data.get('capacitor', 0)
                
                logger.info(f"âš™ï¸ åº”ç”¨é¢‘ç‡ {frequency:.3f}MHz çš„ä¼˜åŒ–é…ç½®: ç½‘ç»œ={network}, ç”µæ„Ÿ={inductance}, ç”µå®¹={capacitance}")
                self.send_relay_status(sw, inductance, capacitance)
                return True
        
        # å¦‚æœæ²¡æœ‰å­˜å‚¨çš„é…ç½®ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨é¢„è®¾é¢‘ç‡èŒƒå›´å†…
        for preset_freq, preset_config in PRESET_FREQUENCIES.items():
            if abs(frequency - preset_freq) <= 0.05:  # 50kHzèŒƒå›´å†…
                logger.info(f"âš™ï¸ åº”ç”¨é¢„è®¾é¢‘ç‡ {preset_freq}MHz çš„é…ç½®: ç½‘ç»œ={'CL' if preset_config['sw'] else 'LC'}, ç”µæ„Ÿ={preset_config['inductor']}, ç”µå®¹={preset_config['capacitor']}")
                self.send_relay_status(preset_config['sw'], preset_config['inductor'], preset_config['capacitor'])
                return True
        
        # å¦‚æœä¸åœ¨é¢„è®¾é¢‘ç‡èŒƒå›´å†…ï¼ŒæŸ¥æ‰¾æœ€è¿‘çš„æ³¢æ®µå¹¶åº”ç”¨é»˜è®¤é…ç½®
        closest_band = None
        min_diff = float('inf')
        for band, center in BAND_CENTERS.items():
            diff = abs(frequency - center)
            if diff < min_diff:
                min_diff = diff
                closest_band = band
        
        # å¦‚æœé¢‘ç‡åœ¨æ³¢æ®µèŒƒå›´å†…ï¼ˆÂ±100kHzï¼‰ï¼Œåº”ç”¨è¯¥æ³¢æ®µçš„é»˜è®¤é…ç½®
        if min_diff <= 0.1 and closest_band in DEFAULT_BAND_CONFIGS:  # 100kHzèŒƒå›´å†…
            band_config = DEFAULT_BAND_CONFIGS[closest_band]
            sw = 1 if band_config['network'] == 'CL' else 0
            logger.info(f"âš™ï¸ åº”ç”¨{closest_band}æ³¢æ®µçš„é»˜è®¤é…ç½®: ç½‘ç»œ={band_config['network']}, ç”µæ„Ÿ={band_config['inductor']}, ç”µå®¹={band_config['capacitor']}")
            self.send_relay_status(sw, band_config['inductor'], band_config['capacitor'])
            return True
        
        logger.info(f"ğŸ” é¢‘ç‡ {frequency:.3f}MHz æ²¡æœ‰å¯ç”¨çš„é…ç½®")
        return False
    
    def stop(self):
        """åœæ­¢å®¢æˆ·ç«¯"""
        self.running = False
        if self.ws:
            self.ws.close()

class AtuWebSocketHandler(tornado.websocket.WebSocketHandler):
    """ATUç›‘æ§WebSocketå¤„ç†å™¨"""
    
    def check_origin(self, origin):
        # å…è®¸è·¨åŸŸè®¿é—®
        return True
    
    def open(self):
        global atu_ws_clients
        
        if self not in atu_ws_clients:
            atu_ws_clients.append(self)
        
        logger.info(f"æ–°çš„ATUç›‘æ§å®¢æˆ·ç«¯è¿æ¥ï¼Œå½“å‰å®¢æˆ·ç«¯æ•°: {len(atu_ws_clients)}")
        logger.info(f"å®¢æˆ·ç«¯ä¿¡æ¯: {self.request.remote_ip}, {self.request.headers}")
        
        # å‘é€å½“å‰çŠ¶æ€
        self.write_message(json.dumps({
            'type': 'status',
            'message': 'è¿æ¥æˆåŠŸ',
            'connected': atu_device_connected
        }))
    
    def on_message(self, message):
        try:
            data = json.loads(message)
            
            if data.get('type') == 'command':
                # å¤„ç†å®¢æˆ·ç«¯å‘½ä»¤
                command = data.get('command')
                if command == 'sync':
                    # å‘é€åŒæ­¥å‘½ä»¤åˆ°ATUè®¾å¤‡
                    if atu_ws_client and atu_ws_client.connected:
                        atu_ws_client.send_sync()
                elif command == 'status':
                    # è¿”å›å½“å‰çŠ¶æ€
                    self.write_message(json.dumps({
                        'type': 'status',
                        'message': 'çŠ¶æ€æŸ¥è¯¢',
                        'connected': atu_device_connected
                    }))
                elif command == 'tune_status' and 'value' in data:
                    # å‘é€è°ƒè°çŠ¶æ€å‘½ä»¤
                    if atu_ws_client and atu_ws_client.connected:
                        atu_ws_client.send_tune_status(data['value'])
                elif command == 'tune_mode' and 'value' in data:
                    # å‘é€è°ƒè°æ¨¡å¼å‘½ä»¤
                    if atu_ws_client and atu_ws_client.connected:
                        atu_ws_client.send_tune_mode(data['value'])
                elif command == 'relay_status' and 'sw' in data and 'ind' in data and 'cap' in data:
                    # å‘é€ç»§ç”µå™¨çŠ¶æ€å‘½ä»¤
                    if atu_ws_client and atu_ws_client.connected:
                        atu_ws_client.send_relay_status(data['sw'], data['ind'], data['cap'])
                elif command == 'get_optimized_config' and 'frequency' in data:
                    # è·å–ä¼˜åŒ–é…ç½®
                    config = atu_ws_client.get_optimized_config(data['frequency'])
                    self.write_message(json.dumps({
                        'type': 'optimized_config',
                        'frequency': data['frequency'],
                        'config': config
                    }))
                elif command == 'apply_optimized_config' and 'frequency' in data:
                    # åº”ç”¨ä¼˜åŒ–é…ç½®
                    success = atu_ws_client.apply_optimized_config(data['frequency'])
                    self.write_message(json.dumps({
                        'type': 'apply_config_result',
                        'frequency': data['frequency'],
                        'success': success
                    }))
                elif command == 'save_optimized_config' and 'frequency' in data and 'swr' in data and 'relay' in data:
                    # ä¿å­˜ä¼˜åŒ–é…ç½®
                    atu_ws_client.update_optimized_config(data['frequency'], data['swr'], data['relay'])
                    self.write_message(json.dumps({
                        'type': 'config_saved',
                        'frequency': data['frequency']
                    }))
                elif command == 'update_frequency' and 'frequency' in data:
                    # æ›´æ–°å½“å‰é¢‘ç‡
                    update_current_frequency(data['frequency'])
                    self.write_message(json.dumps({
                        'type': 'frequency_updated',
                        'frequency': data['frequency']
                    }))
                elif command == 'get_optimized_config' and 'frequency' in data:
                    # è·å–ä¼˜åŒ–é…ç½®
                    config = atu_ws_client.get_optimized_config(data['frequency'])
                    self.write_message(json.dumps({
                        'type': 'optimized_config',
                        'frequency': data['frequency'],
                        'config': config
                    }))
                elif command == 'apply_optimized_config' and 'frequency' in data:
                    # åº”ç”¨ä¼˜åŒ–é…ç½®
                    success = atu_ws_client.apply_optimized_config(data['frequency'])
                    self.write_message(json.dumps({
                        'type': 'apply_config_result',
                        'frequency': data['frequency'],
                        'success': success
                    }))
                elif command == 'save_optimized_config' and 'frequency' in data and 'swr' in data and 'relay' in data:
                    # ä¿å­˜ä¼˜åŒ–é…ç½®
                    atu_ws_client.update_optimized_config(data['frequency'], data['swr'], data['relay'])
                    self.write_message(json.dumps({
                        'type': 'config_saved',
                        'frequency': data['frequency']
                    }))
                    
        except Exception as e:
            logger.error(f"å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯é”™è¯¯: {e}")
                    
        except Exception as e:
            logger.error(f"å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯é”™è¯¯: {e}")
    
    def on_close(self):
        global atu_ws_clients
        
        if self in atu_ws_clients:
            atu_ws_clients.remove(self)
        
        logger.info(f"ATUç›‘æ§å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œå‰©ä½™å®¢æˆ·ç«¯æ•°: {len(atu_ws_clients)}")

class AtuMonitorHandler(tornado.web.RequestHandler):
    """ATUç›‘æ§é¡µé¢å¤„ç†å™¨"""
    
    def get(self):
        try:
            # è¯»å–ATUç›‘æ§é¡µé¢
            with open("www/atu_monitor.html", "r") as f:
                content = f.read()
            self.write(content)
        except Exception as e:
            logger.error(f"è¯»å–ATUç›‘æ§é¡µé¢å¤±è´¥: {e}")
            self.write("<html><body><h1>ATUç›‘æ§ç³»ç»Ÿ</h1><p>é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ã€‚</p></body></html>")

class AtuStatusHandler(tornado.web.RequestHandler):
    """ATUçŠ¶æ€APIå¤„ç†å™¨"""
    
    def get(self):
        global atu_device_connected
        
        status = {
            'atu_device_connected': atu_device_connected,
            'atu_device_ip': ATU_DEVICE_IP,
            'atu_device_port': ATU_DEVICE_PORT,
            'websocket_clients': len(atu_ws_clients),
            'server_time': datetime.datetime.now().isoformat()
        }
        
        self.set_header('Content-Type', 'application/json')
        self.write(json.dumps(status))

def main():
    """ä¸»å‡½æ•°"""
    
    # åˆ›å»ºTornadoåº”ç”¨
    app = tornado.web.Application([
        (r'/atu/ws', AtuWebSocketHandler),
        (r'/atu/monitor', AtuMonitorHandler),
        (r'/atu/status', AtuStatusHandler),
        (r'/atu/(.*)', tornado.web.StaticFileHandler, {'path': './www'}),
        (r'/(.*)', tornado.web.StaticFileHandler, {'path': './www'})
    ], debug=True)
    
    # é…ç½®SSLè¯ä¹¦
    ssl_options = {
        "certfile": "certs/fullchain_complete.pem",
        "keyfile": "certs/radio.vlsc.net.key"
    }
    
    # å¯åŠ¨HTTPSæœåŠ¡å™¨
    http_server = tornado.httpserver.HTTPServer(app, ssl_options=ssl_options)
    # ç›‘å¬æ‰€æœ‰IPv6åœ°å€ï¼Œæ”¯æŒè¿œç¨‹è®¿é—®
    http_server.listen(ATU_SERVER_PORT, address='::')
    
    logger.info(f"ATUæœåŠ¡å™¨å¯åŠ¨åœ¨ç«¯å£ {ATU_SERVER_PORT}")
    logger.info(f"ATUç›‘æ§é¡µé¢: https://[::]:{ATU_SERVER_PORT}/atu/monitor (IPv6)")
    logger.info(f"ATUç›‘æ§é¡µé¢: https://localhost:{ATU_SERVER_PORT}/atu/monitor (IPv4)")
    logger.info(f"ATUçŠ¶æ€API: https://[::]:{ATU_SERVER_PORT}/atu/status (IPv6)")
    logger.info(f"ATUçŠ¶æ€API: https://localhost:{ATU_SERVER_PORT}/atu/status (IPv4)")
    
    # å¯åŠ¨ATUè®¾å¤‡WebSocketå®¢æˆ·ç«¯
    global atu_ws_client
    atu_ws_client = AtuWebSocketClient()
    atu_ws_client.connect()
    
    
    try:
        # å¯åŠ¨Tornadoäº‹ä»¶å¾ªç¯
        tornado.ioloop.IOLoop.current().start()
    except KeyboardInterrupt:
        logger.info("æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...")
    finally:
        # æ¸…ç†èµ„æº
        if atu_ws_client:
            atu_ws_client.stop()
        
        logger.info("ATUæœåŠ¡å™¨å·²å…³é—­")

if __name__ == "__main__":
    main()
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>UHRR Audio Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        #log { height: 300px; overflow-y: scroll; background: #000; color: #00ff00; padding: 10px; font-family: monospace; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>UHRR Audio Fix Verification</h1>
        
        <div class="test-section">
            <h3>Audio Configuration Test</h3>
            <button onclick="testSampleRates()">Check Sample Rates</button>
            <button onclick="testAudioContext()">Test AudioContext</button>
            <button onclick="testWebSocketConnections()">Check WebSocket Connections</button>
            <button onclick="runFullDiagnostic()">Run Full Diagnostic</button>
        </div>
        
        <div class="test-section">
            <h3>Test Log</h3>
            <div id="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function testSampleRates() {
            log('Testing sample rates...', 'info');
            
            const sampleRates = {
                'Desktop interface': window.AudioRX_sampleRate || 'Not found',
                'Mobile interface': window.audioRXSampleRate || 'Not found'
            };
            
            Object.entries(sampleRates).forEach(([interface, rate]) => {
                if (rate === 24000) {
                    log(`✅ ${interface}: ${rate}Hz (CORRECT)`, 'success');
                } else {
                    log(`❌ ${interface}: ${rate}Hz (INCORRECT - should be 24000Hz)`, 'error');
                }
            });
        }
        
        function testAudioContext() {
            log('Testing AudioContext creation...', 'info');
            
            if (window.AudioContext || window.webkitAudioContext) {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)({sampleRate: 24000});
                    log(`✅ AudioContext created successfully with 24000Hz`, 'success');
                    log(`📊 Actual sample rate: ${ctx.sampleRate}Hz`, 'info');
                    ctx.close();
                } catch (e) {
                    log(`❌ Failed to create AudioContext: ${e.message}`, 'error');
                }
            } else {
                log('❌ AudioContext API not supported', 'error');
            }
        }
        
        function testWebSocketConnections() {
            log('Testing WebSocket connections...', 'info');
            
            const websockets = {
                'Control WebSocket': window.wsControlTRX,
                'Audio RX WebSocket': window.wsAudioRX,
                'Audio TX WebSocket': window.wsAudioTX
            };
            
            Object.entries(websockets).forEach(([name, ws]) => {
                if (ws) {
                    const state = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'][ws.readyState];
                    if (ws.readyState === WebSocket.OPEN) {
                        log(`✅ ${name}: ${state}`, 'success');
                    } else {
                        log(`⚠️ ${name}: ${state}`, 'warning');
                    }
                } else {
                    log(`❌ ${name}: Not initialized`, 'error');
                }
            });
        }
        
        function runFullDiagnostic() {
            clearLog();
            log('=== UHRR Audio Diagnostic ===', 'info');
            
            testSampleRates();
            testAudioContext();
            testWebSocketConnections();
            
            log('=== Diagnostic Complete ===', 'info');
        }
        
        // Auto-run diagnostic on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                runFullDiagnostic();
            }, 1000);
        });
    </script>
</body>
</html>